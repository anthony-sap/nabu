# Feature Summary

This file tracks completed features in the Nabu project.

## Completed Features

### Image Upload Support for Lexical Editor
**Completed:** November 13, 2024  
**Feature ID:** image-upload-support  
**Updated:** November 13, 2024 - Selection and deletion fixes completed

Complete image upload functionality for the Lexical rich text editor including:
- Client-side image compression (max 2MB, 1920px)
- **SVG support** (no compression, infinite scaling)
- **Secure direct uploads via backend-generated signed URLs** (no Supabase SDK on frontend)
- Drag-and-drop and paste support
- **Full selection support** (mouse click and keyboard navigation)
- **Dual deletion methods** (keyboard Delete/Backspace or hover button)
- Visual selection indicator (blue ring)
- Storage usage dashboard showing statistics and top files
- Full audit trail with multi-tenant support
- Comprehensive API endpoints for upload, confirmation, and deletion

**Security Highlights:**
- No Supabase credentials exposed to frontend
- Temporary signed URLs (5 min expiry, single-use)
- Server-side ownership validation before URL generation
- Plain `fetch()` API for uploads (no external dependencies)

**Key Components:**
- Custom Lexical ImageNode for editor integration
- Image upload hook with progress tracking using plain fetch
- Backend-only Supabase utilities for signed URL generation
- Storage statistics API and dashboard
- Database model with audit fields

**Files:** 18 created, 7 modified, 1 database migration

See [detailed documentation](.devreadyai/completed-features/image-upload-support_details.md)  
See [signed URL refactor notes](.devreadyai/completed-features/image-upload-refactor-signed-urls.md)  
See [SVG support notes](.devreadyai/completed-features/svg-support-added.md)  
See [selection and delete fix](.devreadyai/completed-features/image-selection-delete-fixed.md)

### Metadata Sidebar Layout
**Completed:** November 13, 2024  
**Feature ID:** metadata-sidebar-layout

Restructured note editor with dedicated metadata sidebar:
- **Fixed 280px right-hand sidebar** that remains visible while scrolling
- **Created date display** in full date/time format (e.g., "Nov 13, 2024 at 2:30 PM")
- **Tags section** with removal functionality
- **Source URLs section** showing captured URLs from editor
- **Linked Notes section** with add/delete capabilities
- **Responsive design** - hidden on mobile, visible on desktop
- **Sticky positioning** keeps metadata in view while scrolling long notes
- **Improved content focus** - editor now has more horizontal space

**Key Improvements:**
- Better visual hierarchy with metadata consolidated in dedicated space
- Always-accessible metadata without interrupting content flow
- Cleaner mobile experience with full-width content
- Consistent styling across all metadata sections

**Files:** 1 created, 1 modified

See [detailed documentation](.devreadyai/completed-features/metadata-sidebar-layout.md)

### Embeddings System with Chunking + Semantic Search
**Completed:** November 14, 2024  
**Feature ID:** embeddings-chunking-system  
**Updated:** November 14, 2024 - Semantic search fully implemented with OpenAI

Complete vector embeddings system for semantic search on notes and thoughts with chunking architecture:
- **Chunking support** for content of any length (~2000 chars/chunk with 200 char overlap)
- **OpenAI embeddings** using text-embedding-3-small (512 dimensions)
- **Automatic updates** when notes/thoughts are modified
- **Automatic cleanup** via CASCADE when entities are deleted
- **Full semantic search** - find notes by meaning, not just keywords
- **Hybrid search API** combining keyword (40%) + vector similarity (60%)
- **Production-ready** with comprehensive setup documentation

**Architecture:**
- Model: OpenAI `text-embedding-3-small` (512 dimensions)
- Storage: Separate `NoteChunk` and `ThoughtChunk` tables with pgvector
- Processing: Asynchronous via database webhooks → Edge Functions
- Cost: ~$0.02 per 1,000 notes (very affordable)

**Key Features:**
- Smart text chunking with sentence boundary detection
- Lexical/HTML content extraction
- Job queue with retry logic (max 3 attempts)
- ivfflat indexes for fast vector similarity search
- Configurable hybrid search weights (default: 40% keyword, 60% vector)
- Multi-tenant isolation and security

**Database Changes:**
- Removed old `Note.embedding` and `Thought.embedding` fields
- Created `NoteChunk`, `ThoughtChunk`, `EmbeddingJob` tables
- Added pgvector extension and ivfflat indexes

**Files:** 9 created, 8 modified, 3 database migrations

**Status:** ✅ Fully operational with semantic search working in production

See [detailed documentation](.devreadyai/completed-features/embeddings-chunking-system.md)  
See [production setup guide](../EMBEDDINGS_SETUP.md)  
See [semantic search testing guide](../SEMANTIC_SEARCH_TESTING.md)  
See [future features](.devreadyai/other/embeddings-future-features.md)

### Local Storage Auto-Save and Embedding Batching
**Completed:** November 14, 2024  
**Feature ID:** local-storage-autosave-and-embedding-batching

Implemented intelligent auto-save system with local storage persistence and background embedding generation:

**Auto-Save System:**
- **Local save every 5 seconds** to browser localStorage (fast, prevents data loss)
- **Server sync every 60 seconds** to database (persistent backup)
- **Save on page leave** using beforeunload and component unmount handlers
- **Timestamp comparison** always loads newest version (local vs server)
- **Smart conflict resolution** with toast notifications when local version is newer
- **Visual status indicators** showing "Saved locally" vs "Synced" states

**Embedding Batching:**
- **Background cron job** (pg_cron + Supabase Edge Function)
- **2-minute cooldown** before generating embeddings after editing stops
- **Runs every 2 minutes** processing up to 50 notes per batch
- **Standalone Edge Function** - no Next.js API dependency
- **80-90% cost reduction** in embedding API calls
- **Decoupled from save operations** for better performance

**Architecture:**
- localStorage: Fast local persistence with timestamps
- Server API: RESTful endpoints for sync
- Edge Function: `process-pending-embeddings` triggered by pg_cron (every 2 min)
- Standalone: Edge Function creates chunks and jobs directly (no Next.js API)
- Database: `lastEmbeddingGeneratedAt` field tracks generation status

**Benefits:**
- No data loss on browser crash or accidental tab close
- Always loads most recent version across devices
- Dramatically reduced embedding costs during active editing
- Better UX with clear save status indicators
- Reliable background processing without blocking user

**Files:** 2 created, 3 modified, 1 database migration, comprehensive setup documentation

See [detailed documentation](.devreadyai/completed-features/local-storage-autosave-and-embedding-batching_details.md)  
See [setup guide](../EMBEDDINGS_BACKGROUND_JOB_SETUP.md)

### WhatsApp Personal Account Integration
**Completed:** January 15, 2025  
**Feature ID:** whatsapp-personal-integration-64d97f-cf6325e7

Complete WhatsApp Business Cloud API integration enabling users to capture thoughts via WhatsApp messages:

**Core Features:**
- **Secure phone linking** - One-time tokens with 15-minute expiration
- **Automatic Thought creation** - Messages become Thoughts with AI enrichment
- **Webhook processing** - Real-time message reception with signature verification
- **Settings management** - User-friendly UI to link/unlink phone numbers
- **WhatsApp badges** - Visual indicators showing message source in UI

**User Flow:**
1. User messages the Nabu WhatsApp bot
2. Bot sends secure linking URL (if phone not linked)
3. User clicks link and confirms in browser
4. All future messages automatically create Thoughts
5. Full management via Settings → WhatsApp

**Architecture:**
- **4 new database models** (WhatsAppIntegration, UserPhoneLink, WhatsAppLinkToken, WhatsAppMessage)
- **Webhook endpoint** - Fast response (<5s) with async processing
- **Token-based security** - Cryptographic tokens with expiration
- **Multi-tenant support** - Full tenant isolation
- **Audit trail** - Complete history with soft deletes

**Technical Highlights:**
- HMAC-SHA256 signature verification for webhooks
- E.164 phone number format standardization
- Media attachment support (placeholder for future enhancement)
- Automatic AI embedding generation for messages
- Comprehensive error tracking and retry logic

**Files:** 14 created (6 libraries, 3 API routes, 2 pages, 2 components, 1 documentation), 4 modified, 1 database migration

**Documentation:**
- [Implementation details](.devreadyai/completed-features/whatsapp-personal-integration-implementation.md)
- [Setup guide](.devreadyai/other/whatsapp-setup.md) - Comprehensive 300+ line setup guide with troubleshooting
- [Quick reference](.devreadyai/other/whatsapp-quick-reference.md) - Developer quick-start and common tasks

**Production Ready:** Pending WhatsApp Business account setup and environment configuration

### Note Version History
**Completed:** November 23, 2024  
**Feature ID:** note-version-history

Complete revision history system for notes with automatic versioning, manual snapshots, and restore capabilities:

**Core Features:**
- **Automatic versioning** - Snapshots created every 5 minutes during active editing
- **Manual snapshots** - Save versions with custom descriptions anytime
- **Smart retention** - Keep max 50 autosave versions OR 90 days (manual versions never deleted)
- **Full preview** - View any version with Lexical formatting preserved
- **Safe restore** - Creates backup before restoring, allowing undo
- **Version history panel** - Collapsible sidebar showing all versions chronologically

**User Flow:**
1. User edits note, autosave creates versions every 5 minutes
2. User can manually save important versions with descriptions
3. Click "History" to open version history panel
4. Preview any version to see full content
5. Restore with one click (automatic backup created)
6. Version history persists across devices and sessions

**Architecture:**
- **NoteVersion model** - Stores title, content, contentState (Lexical JSON)
- **Sequential numbering** - Easy version references (v1, v2, v3...)
- **Reason tracking** - "autosave" | "manual" | "restore"
- **Multi-tenant isolation** - Full tenant support with audit fields
- **Automatic pruning** - Retention rules applied asynchronously

**Technical Highlights:**
- Fire-and-forget versioning doesn't block saves
- Lexical editor state fully preserved and restored
- Soft deletes allow version recovery
- Pagination prevents loading all versions at once
- Backend service layer separates business logic from API
- Comprehensive API with 5 endpoints

**Retention Policy:**
- Autosave: Max 50 versions OR 90 days (whichever includes more)
- Manual: Never deleted (permanent record)
- Restore: Never deleted (audit trail)

**Files:** 8 created (1 service, 4 API routes, 3 components), 2 modified, 1 database migration

See [detailed documentation](.devreadyai/completed-features/note-version-history_details.md)

