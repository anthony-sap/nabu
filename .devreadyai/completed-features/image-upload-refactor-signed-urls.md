# Image Upload Refactor: Signed URLs Only

**Date:** November 13, 2024  
**Type:** Security Enhancement / Refactor  
**Feature:** Image Upload Support

## Overview

Refactored the image upload implementation to remove all Supabase client-side dependencies and use only signed URLs generated by the backend. This improves security and simplifies the frontend.

## Changes Made

### 1. Removed Client-Side Supabase Dependencies

**Before:**
- Frontend imported and used `@supabase/supabase-js` client
- Required `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- Exposed Supabase credentials to browser

**After:**
- Frontend uses only standard `fetch()` API
- No Supabase SDK on frontend
- Only server-side credentials: `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`
- Signed URLs are temporary (5 min) and single-use

### 2. Updated Upload Flow

**Frontend (`components/nabu/notes/use-image-upload.ts`):**
```typescript
// Step 3: Direct upload using signed URL with plain fetch
const uploadResponse = await fetch(uploadUrl, {
  method: "PUT",
  body: compressedFile,
  headers: {
    "Content-Type": metadata.mimeType,
    "x-upsert": "false",
  },
});
```

**Backend remains the same:**
- `/api/nabu/images/upload-url` generates signed URL
- `/api/nabu/images/[imageId]/confirm` confirms completion

### 3. Environment Variables

**Updated `env.ts`:**
```typescript
server: {
  // Server-side only
  SUPABASE_URL: z.string().url(),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
}
client: {
  // No Supabase variables on client
}
```

### 4. Deprecated Client Function

**Updated `lib/supabase.ts`:**
```typescript
export function getClientSupabaseClient() {
  throw new Error(
    "getClientSupabaseClient is deprecated. Use signed URLs from the backend instead."
  );
}
```

## Benefits

### Security
✅ **No credentials in browser** - Service role key never leaves backend  
✅ **Temporary URLs** - Signed URLs expire after 5 minutes  
✅ **Single-use** - Each upload requires a new signed URL  
✅ **Ownership validation** - Backend validates user owns note before issuing URL

### Performance
✅ **Direct uploads** - Files go directly to Supabase, not through API server  
✅ **Smaller bundle** - No Supabase SDK in frontend bundle  
✅ **Native fetch** - Uses browser's built-in fetch API

### Simplicity
✅ **Fewer dependencies** - Frontend doesn't need Supabase package  
✅ **Cleaner code** - Plain fetch instead of SDK calls  
✅ **Easier testing** - Standard HTTP requests easier to mock

## Files Modified

1. `components/nabu/notes/use-image-upload.ts` - Removed Supabase client, use plain fetch
2. `env.ts` - Removed public Supabase env vars, added server-side SUPABASE_URL
3. `lib/supabase.ts` - Deprecated client-side function, updated server function
4. `.devreadyai/completed-features/image-upload-support_details.md` - Updated documentation

## Migration Notes

### For Existing Installations

**Before (OLD - don't use):**
```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...
```

**After (NEW - use this):**
```env
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...
```

Remove the `NEXT_PUBLIC_*` variables from your `.env` file.

### No Code Changes Required

Existing upload functionality works exactly the same from user perspective:
- Drag and drop ✓
- Paste from clipboard ✓
- Toolbar button upload ✓
- Image deletion ✓

## Testing Verified

- ✅ Upload via toolbar button
- ✅ Drag and drop upload
- ✅ Paste from clipboard
- ✅ Direct storage upload (no server pass-through)
- ✅ No linting errors
- ✅ Signed URL expiration (5 minutes)
- ✅ No credentials in frontend bundle

## Recommendation

This approach is now the **recommended pattern** for all future Supabase storage integrations in the Nabu project.

**When to use signed URLs:**
- File uploads from browser
- Temporary access to private files
- User-generated content

**When to use service role:**
- Server-side operations only
- Administrative tasks
- Backend data processing

