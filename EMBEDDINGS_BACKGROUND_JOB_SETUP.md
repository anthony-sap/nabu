# Embeddings Background Job Setup

This document explains how to set up the background job system that generates embeddings for notes after a 2-minute cooldown period.

## Overview

To prevent excessive embedding generation during active editing sessions, embeddings are now generated by a background cron job instead of immediately on every save:

- **Local Save**: Every 5 seconds to localStorage
- **Server Sync**: Every 60 seconds to database
- **Embedding Generation**: 2+ minutes after last edit (via background job)

## Architecture

```
User edits note
    ↓
Auto-save to localStorage (5s)
    ↓
Auto-save to server (60s)
    ↓
[Wait 2 minutes of inactivity]
    ↓
pg_cron triggers Edge Function (every 2 min)
    ↓
Edge Function finds stale notes
    ↓
Creates chunks and embedding jobs directly
    ↓
Embeddings generated asynchronously
```

## Components

### 1. Database Schema

Added `lastEmbeddingGeneratedAt` field to Note model:

```prisma
model Note {
  // ... other fields ...
  lastEmbeddingGeneratedAt DateTime? // When embeddings were last generated (for batching)
  // ... other fields ...
}
```

### 2. Edge Function

**Location**: `supabase/functions/process-pending-embeddings/index.ts`

**Purpose**: 
- Queries for notes that haven't been edited in 2+ minutes
- Calls internal API to enqueue embedding jobs
- Updates `lastEmbeddingGeneratedAt` timestamp

**Triggered by**: pg_cron every 2 minutes

### 3. Modified Note Endpoints

**Changed**:
- `app/api/nabu/notes/route.ts` (POST) - Removed immediate embedding trigger
- `app/api/nabu/notes/[id]/route.ts` (PATCH) - Removed immediate embedding trigger

**Reason**: Background job now handles embedding generation after cooldown period

## Setup Instructions

### Prerequisites

- Supabase project set up
- `SUPABASE_SERVICE_ROLE_KEY` environment variable configured
- Edge Function is standalone - no Next.js API dependency

### Step 1: Apply Database Migration

The migration has already been created and applied:

```bash
npx prisma migrate deploy
```

Migration file: `20251114035927_add_last_embedding_generated_at_to_notes`

### Step 2: Deploy Edge Function

Deploy the Edge Function to Supabase:

```bash
npx supabase functions deploy process-pending-embeddings
```

**Note**: Ensure you have the Supabase CLI installed and authenticated.

### Step 3: Set Environment Variables

In your Supabase project settings, add the following environment variables for the Edge Function:

```bash
# Supabase Dashboard → Settings → Edge Functions → Secrets
SUPABASE_URL=<your-supabase-url>
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
```

**Note:** The Edge Function is now standalone and does NOT require `NEXT_PUBLIC_APP_URL`

### Step 4: Enable pg_cron Extension

1. Go to Supabase Dashboard
2. Navigate to **Database** → **Extensions**
3. Search for `pg_cron`
4. Click **Enable**

### Step 5: Create Cron Job

Connect to your Supabase database using the SQL Editor and run:

```sql
-- Create cron job to run every 2 minutes
SELECT cron.schedule(
  'process-pending-embeddings',           -- Job name
  '*/2 * * * *',                          -- Cron expression (every 2 minutes)
  $$
  SELECT
    net.http_post(
      url := '<your-edge-function-url>/process-pending-embeddings',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer <your-anon-key>'
      ),
      body := '{}'::jsonb
    ) AS request_id;
  $$
);
```

**Replace**:
- `<your-edge-function-url>`: Your Supabase Edge Functions URL (e.g., `https://abcdefghijklmnop.supabase.co/functions/v1`)
- `<your-anon-key>`: Your Supabase anon key (found in Project Settings → API)

### Step 6: Verify Cron Job

Check that the cron job was created successfully:

```sql
SELECT * FROM cron.job WHERE jobname = 'process-pending-embeddings';
```

### Step 7: Monitor Execution

View cron job execution history:

```sql
SELECT * FROM cron.job_run_details 
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'process-pending-embeddings')
ORDER BY start_time DESC
LIMIT 10;
```

## How It Works

### Note Creation/Update Flow

1. User creates or edits a note
2. Note auto-saves locally (5s) and to server (60s)
3. `updatedAt` timestamp is updated in database
4. `lastEmbeddingGeneratedAt` remains NULL or older than `updatedAt`

### Background Job Flow

Every 2 minutes, the cron job:

1. Triggers `process-pending-embeddings` Edge Function
2. Function queries for notes where:
   - `updatedAt < 2 minutes ago`
   - `deletedAt IS NULL`
   - `(lastEmbeddingGeneratedAt IS NULL OR lastEmbeddingGeneratedAt < updatedAt)`
3. For each note found (max 50 per run):
   - Extracts and chunks the content
   - Creates `NoteChunk` records directly in database
   - Creates `EmbeddingJob` records with PENDING status
   - Updates `lastEmbeddingGeneratedAt` to current timestamp
4. Embedding jobs are processed asynchronously by database webhooks

### Example Timeline

```
12:00:00 - User starts editing note
12:01:00 - Server sync (60s) → updatedAt = 12:01:00
12:01:30 - User continues editing
12:02:30 - Server sync (60s) → updatedAt = 12:02:30
12:03:00 - User stops editing
12:03:30 - No more edits
12:04:00 - Cron job runs
          → updatedAt (12:02:30) was <2 min ago
          → Still too recent, skip
12:06:00 - Cron job runs
          → updatedAt (12:02:30) was >2 min ago (now 12:06:00)
          → Eligible! Generate embeddings
          → lastEmbeddingGeneratedAt = 12:06:00
```

## Monitoring

### Check Edge Function Logs

```bash
npx supabase functions logs process-pending-embeddings
```

### Check Pending Notes

See how many notes are waiting for embeddings:

```sql
SELECT COUNT(*) 
FROM "Note" 
WHERE "updatedAt" < NOW() - INTERVAL '2 minutes'
  AND "deletedAt" IS NULL
  AND ("lastEmbeddingGeneratedAt" IS NULL OR "lastEmbeddingGeneratedAt" < "updatedAt");
```

### Check Recent Embedding Jobs

```sql
SELECT * FROM "EmbeddingJob"
WHERE "createdAt" > NOW() - INTERVAL '1 hour'
ORDER BY "createdAt" DESC
LIMIT 20;
```

## Troubleshooting

### Cron job not running

1. Check if pg_cron extension is enabled:
   ```sql
   SELECT * FROM pg_extension WHERE extname = 'pg_cron';
   ```

2. Check cron job status:
   ```sql
   SELECT * FROM cron.job WHERE jobname = 'process-pending-embeddings';
   ```

3. Check execution logs:
   ```sql
   SELECT * FROM cron.job_run_details 
   WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'process-pending-embeddings')
   ORDER BY start_time DESC;
   ```

### Edge Function errors

1. Check Edge Function logs in Supabase Dashboard
2. Verify environment variables are set correctly
3. Test Edge Function manually:
   ```bash
   curl -X POST https://<your-project>.supabase.co/functions/v1/process-pending-embeddings \
     -H "Authorization: Bearer <your-anon-key>"
   ```

### Embeddings not generating

1. Check internal API endpoint is accessible
2. Verify `SUPABASE_SERVICE_ROLE_KEY` matches in both Edge Function and Next.js app
3. Check `NEXT_PUBLIC_APP_URL` points to correct deployment
4. Review embedding job queue:
   ```sql
   SELECT * FROM "EmbeddingJob" WHERE status = 'PENDING' ORDER BY "createdAt" DESC;
   ```

## Cleanup

To remove the cron job:

```sql
SELECT cron.unschedule('process-pending-embeddings');
```

To remove all pending notes' lastEmbeddingGeneratedAt (force regeneration):

```sql
UPDATE "Note" SET "lastEmbeddingGeneratedAt" = NULL;
```

## Cost Considerations

- **Cron Job Frequency**: Running every 2 minutes = 720 executions/day
- **Edge Function Invocations**: ~720/day (lightweight queries)
- **Embedding API Calls**: Reduced by ~80-90% compared to immediate generation
- **Benefits**: Significant cost savings during active editing sessions
- **Faster Response**: Notes get embeddings within 4 minutes (2 min cooldown + 2 min cron)

## Future Improvements

Potential enhancements:

1. **Adaptive Frequency**: Adjust cron frequency based on activity patterns
2. **Priority Queue**: Process recently accessed notes first
3. **Batch Size Tuning**: Adjust max notes per run based on performance
4. **Metrics Dashboard**: Track embedding generation efficiency
5. **Manual Trigger**: Add UI button to force immediate embedding generation

